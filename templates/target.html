{% load static %}
{% load i18n %}
{% load mathfilters %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="robots" content="noindex">
  <meta name="googlebot" content="noindex">

  <title>{% if page_title %}{{page_title}} - {% endif %}{% trans 'site_title' %}</title>

  <!-- Font Awesome Icons -->
  <script src="https://kit.fontawesome.com/86688b6ab0.js" crossorigin="anonymous"></script>
  <!-- Ionicons -->
  <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
  <!-- icheck bootstrap -->
  <link rel="stylesheet" href="{% static 'admin-lte/plugins/icheck-bootstrap/icheck-bootstrap.min.css' %}">
  <!-- Theme style -->
  <link rel="stylesheet" href="{% static 'admin-lte/dist/css/adminlte.min.css' %}">
  <!-- Google Font: Source Sans Pro -->
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700" rel="stylesheet">
  
</head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id={{GOOGLE_ANALYTICS_ID}}"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', '{{GOOGLE_ANALYTICS_ID}}');
</script>
<body class="hold-transition fixed layout-top-nav">
<div class="wrapper">

    <div class="content-wrapper">
        <!-- Content Header (Page header) -->
        <div class="content-header">
            <div class="container-fluid">
                <div class="card card-widget widget-user">
                    <!-- Add the bg color to the header using any of the bg-* classes -->
                    <div class="p-3 text-white" style="background: url('{% static 'admin-lte/dist/img/photo1.png' %}') center center;">
                        <div class="row">
                            <div class="col col-md-6 text-nowrap">
                                <h1 class="widget-user-title text-white text-left">目標設定シート</h1>
                            </div>
                            <div class="col col-md-6 text-nowrap">
                                <h3 class="widget-user-username text-right">{{target.viewname}}</h3>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col">
                                <h5 class="widget-user-desc text-right">
                                    {% if target.industory %}{{target.get_industory_display}}{% endif %}
                                    {% if target.industory_opt %}{{target.industory_opt}}{% endif %}
                                </h5>
                                <h5 class="widget-user-desc text-right">
                                    {% if target.job %}{{target.job}}{% endif %}
                                    {% if target.role %}{{target.role}}{% endif %}
                                    {% if target.grade %}{{target.get_grade_display}}{% endif %}
                                </h5>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col col-md-12">
                                {{target.description}}
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                    <div class="row">
                        <div class="col-sm-3 border-right">
                        <div class="description-block">
                            <h5 class="description-header">氏名</h5>
                            <span class="description-text">{{target.last_name}} {{target.first_name}}</span>
                        </div>
                        <!-- /.description-block -->
                        </div>
                        <!-- /.col -->
                        <div class="col-sm-3 border-right">
                        <div class="description-block">
                            <h5 class="description-header">会社名</h5>
                            <span class="description-text">
                                {% if target.org_name %}{{target.org_name}}{% endif %}
                            </span>
                        </div>
                        <!-- /.description-block -->
                        </div>
                        <!-- /.col -->
                        <div class="col-sm-3 border-right">
                            <div class="description-block">
                            <h5 class="description-header">部署・部門</h5>
                            <span class="description-text">{% if target.department_name %}{{target.department_name}}{% endif %}</span>
                            </div>
                            <!-- /.description-block -->
                        </div>
                        <!-- /.col -->
                        <div class="col-sm-3">
                        <div class="description-block">
                            <h5 class="description-header">肩書き</h5>
                            <span class="description-text">{{target.position}}</span>
                        </div>
                        <!-- /.description-block -->
                        </div>
                        <!-- /.col -->
                    </div>
                    <!-- /.row -->
                    </div>
                </div>
            </div><!-- /.container-fluid -->
        </div>
        <!-- /.content-header -->

        <!-- Main content -->
        <div class="content">
            <div class="container-fluid">
                {% if messages %}
                <div class="row">
                    {% for message in messages %}
                    <div class="col col-md-12 alert alert-danger" role="alert">
                        {{ message }}
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                <div class="row">
                    <div class="col col-md-4 text-left text-nowrap pb-3" style="min-width:350px;">
                        作成：{{target.created_at}}
                    </div>
                    <div class="col col-md-8 text-right pb-3" style="min-width:350px;">
                        {% if authenticated %}
                        <form name="auth-passcode" method="post" action="{% url 'exit-authenticated' target.uuid %}">
                            {% csrf_token %}
                            <button class="btn btn-success btn-sm btn-request-evaluation" type="button">
                                <i class="fa-solid fa-user"></i> 新規に評価を依頼
                            </button>

                            <button class="btn btn-primary btn-sm" data-toggle="modal" data-target="#modal-create-action" type="button">
                                <i class="fa fa-plus-square"></i> 行動目標を追加
                            </button>

                            <button type="submit" class="btn btn-danger btn-sm"><i class="fa-solid fa-xmark"></i> 編集を終了</button>
                        </form>
                        {% else %}
                        <form name="auth-passcode" method="post" action="{% url 'auth-passcode' target.uuid %}">
                            {% csrf_token %}
                            パスコード：<input class="form-group form-control-sm pull-right" type="password" name="passcode" id="passcode" size="10" value="">
                            <button type="submit" class="btn btn-primary btn-sm">認証</button>
                        </form>
                        {% endif %}
                    </div>
                </div>
                {% for key, task in tasks.items %}
                <div class="row">
                    <div class="col-12">
                        <div class="card card-outline card-success">
                            <div class="card-header">
                                <h3 class="card-title">{{task.task.parent.parent.name}} -> {{task.task.parent.name}} -> {{task.task.name}}</h3>
                                <div class="card-tools">
                                    <button class="float-right btn btn-success btn-sm" type="button" data-toggle="collapse"
                                    data-target="#related-skills-{{task.task.id}}" aria-expanded="false"
                                    aria-controls="related-skills-{{task.task.id}}">関連スキル・知識を見る</button>
                                </div>
                                <!-- /.card-tools -->
                            </div>
                            <!-- /.card-header -->
                            <div class="card-body p-2">
                                {% for item_relation in task.items %}
                                <div class="row p-3">
                                    <div class="col-md-1 p-1 font-weight-bold text-nowrap">
                                        {{item_relation.item.code}}
                                    </div>
                                    <div class="col-md-9 p-1 font-weight-bold">
                                        <div class="">
                                            {{item_relation.item.name}}
                                        </div>
                                    </div>
                                    <div class="col-md-2 text-right">
                                        {% if authenticated %}
                                        <div class="form-row d-flex">
                                            <div class="col-auto">
                                                <label for="self-evaluation-{{item_relation.id}}">自己評価</label>
                                                <input type="range" class="multi-range self-evaluation" min="0" max="100" step="20"
                                                    id="self-evaluation-{{item_relation.id}}"
                                                    evaluation-id="{{item_relation.id}}"
                                                    name="self-evaluation"
                                                    value="{% if item_relation.self_evaluation %}{{item_relation.self_evaluation}}{% else %}0{% endif %}"
                                                    origin-value="{% if item_relation.self_evaluation %}{{item_relation.self_evaluation}}{% else %}0{% endif %}">
                                            </div>
                                            <div class="col-auto">
                                            </div>
                                        </div>
                                        {% else %}
                                        <div class="progress progress-s">
                                            <div class="progress-bar bg-success" style="width: {{item_relation.self_evaluation}}%">{{item_relation.self_evaluation}}</div>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% for action in item_relation.actions.all %}
                                <div class="row p-1 pl-5">
                                    <div class="col-md-10 text-left">
                                        {% if action.url %}<a href="{{action.url}}" target="_blank">{% endif %}
                                            {{action.name}}
                                        {% if action.url %}</a>{% endif %}
                                    </div>
                                    <div class="col-md-2 text-right">
                                        {% if authenticated %}
                                        <div class="form-row d-flex">
                                            <div class="col-auto">
                                                <label for="self-evaluation-action-{{action.id}}">進捗率</label>
                                                <input type="range" class="multi-range action-progress" min="0" max="100" step="20"
                                                    id="self-evaluation-action-{{action.id}}"
                                                    action-id="{{action.id}}"
                                                    name="progress"
                                                    value="{% if action.progress %}{{action.progress}}{% else %}0{% endif %}"
                                                    origin-value="{% if action.progress %}{{action.progress}}{% else %}0{% endif %}">
                                            </div>
                                            <div class="col-auto">
                                            </div>
                                        </div>
                                        {% else %}
                                        <div class="progress progress-xs w-75">
                                            <div class="progress-bar bg-info" style="width: {{action.progress}}%">{{action.progress}}%　</div>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                                {% endfor %}

                            </div>
                            <!-- /.card-footer -->
                            <div class="card-body">
                                {% for profile in task.profiles %}
                                <span class="badge badge-secondary" data-toggle="tooltip" data-placement="top"
                                    title="{{profile.description}}">{{profile.name}}</span>
                                {% endfor %}
                            </div>
                            <div class="card-body collapse" id="related-skills-{{task.task.id}}">
                                {% for skill in task.skills %}
                                <br>
                                <span class="badge badge-success" data-toggle="tooltip" data-placement="top"
                                    title="{{skill.description}}">{{skill.name}}</span>
                                    {% for knowledge in skill.knowledges.all %}
                                    <span class="badge badge-secondary" data-toggle="tooltip" data-placement="top"
                                    title="{{knowledge.description}}">{{knowledge.name}}</span>
                                    {% endfor %}
                                {% endfor %}
                            </div>
                            <!-- /.card-body -->
                        </div>
                    </div>
                </div>
                {% endfor %}
                <hr>
                <div>
                    <div class="card">
                        <div class="card-header">
                          <h3 class="card-title">作成済みの評価依頼</h3>
                          <div class="card-tools">
                            {{target.evaluations.count}}件
                          </div>
                        </div>
                        <!-- /.card-header -->
                        <div class="card-body p-0">
                          
                          <table class="table table-striped">
                            <tbody>
                                {% for evaluation in target.evaluations.all %}
                                    <td>
                                        <div class="row">
                                            <div class="col col-md-7">
                                                {% if evaluation.status == 100 %}
                                                    {{ request.scheme }}://{{ request.get_host }}{% url "evaluation" evaluation.uuid %}
                                                {% else %}
                                                <div class="input-group mb-3 text-nowrap" style="min-width:300px;">
                                                    <input type="text" name="evaluation_url" class="form-control"
                                                        value="{{ request.scheme }}://{{ request.get_host }}{% url "evaluation" evaluation.uuid %}">
                                                    <div class="input-group-append">
                                                        <button class="input-group-text btn-copy-evaluation-url"
                                                            evaluation-url="{{ request.scheme }}://{{ request.get_host }}{% url "evaluation" evaluation.uuid %}">
                                                            <i class="fa-solid fa-copy"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                                {% endif %}
                                            </div>
                                            <div class="col col-md-2 text-nowrap">
                                                {{evaluation.due_date}}
                                            </div>
                                            <div class="col col-md-2">
                                                <div class="progress progress-xs">
                                                    <div class="progress-bar progress-bar-danger" style="width: {{evaluation.status}}%"></div>
                                                </div>
                                            </div>
                                            <div class="col col-md-1">
                                                {% if evaluation.status == 100 %}
                                                <span class="badge bg-secondary">{{evaluation.get_status_display}}</span>
                                                {% elif evaluation.status == 0 %}
                                                <span class="badge bg-primary">未使用</span>
                                                <button type="button" class="badge bg-success btn-show-request-qr-code"
                                                    evaluation-url="{{ request.scheme }}://{{ request.get_host }}{% url "evaluation" evaluation.uuid %}"
                                                    >QRコード</button>
                                                {% else %}
                                                <span class="badge bg-success">評価中</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                          </table>
                        </div>
                        <!-- /.card-body -->
                      </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-md-12">
                        <div class="card card-outline card-primary">
                            <div class="card-header">
                                <h3 class="card-title">説明・ご注意</h3>
                                <div class="card-tools">
                                </div>
                                <!-- /.card-tools -->
                            </div>
                            <!-- /.card-header -->
                            <div class="card-body p-3">
                                <ul>
                                    <li>目標設定は3〜5項目で3ヶ月前後を目処に振り返りをしてまた新しく作るというサイクルが良いと思います。本ページをブックマークするなりURLをとっておいて見直し、自己評価を振り返ると良いでしょう。</li>
                                    <li>「関連スキル・知識を見る」ボタンを押すと、単語が展開されます。必要な知識を得るための書籍や講座を検索するのにご利用ください。</li>
                                    <li>目標に対するアクションを設定しておくと、進捗・達成率を記録できるようになります（時間があるときにちょこちょこと実装します）</li>
                                    <li>本ツールは現状あくまで個人で運用しているツールです。ご利用は無料です。何かご意見・ご質問等ありましたが現状はTwitterの方でお願いします。</li>
                                    <li>目標設定URLはランダムでユニークに発行されており、本システムでURLを無断で公開することはありません。目標設定URLの取り扱いはあくまで自己責任でお願いいたします。</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
        <!-- /.Main content -->

    </div>
    <!-- /. content-wrapper -->

    <!-- Main Footer -->
    <footer class="main-footer">
        <!-- To the right -->
        <div class="float-right d-none d-sm-inline">
        </div>
        <!-- Default to the left -->
        <strong>Copyright &copy; 2022- <a href="https://twitter.com/haruchaco" target="_blank"><i class="fa-brands fa-twitter"></i></a>.</strong> All rights reserved.
    </footer>

</div>
<!-- /. wrapper -->

{% if authenticated %}
<div class="modal" id="modal-request-evaluation">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">{% trans 'evaluation_request' %}</h4>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
            <div class="row d-flex">
                <div class="col col-md-12  d-flex align-items-center justify-content-center p-3">
                    <p>
                        ユニークな評価用URLを発行しました。URLをコピーして評価を依頼したい人に送信するかQRコードを見せて評価してもらいましょう。
                        評価用URLの有効期限は14日間です。
                    </p>
                </div>
            </div>
            <div class="row d-flex">
                <div class="col col-md-12  d-flex align-items-center justify-content-center p-3">
                    <div id="evaluation-url-qrcode" class="mx-auto">
                    </div>
                </div>
            </div>
            <div class="row d-flex">
                <div class="col col-md-12  d-flex align-items-center justify-content-center">
                    <div class="mx-auto">
                        <div class="input-group mb-3 text-nowrap" style="min-width:300px;">
                            <input type="text" name="evaluation_url" class="form-control" id="evaluation-url"
                                value="https://example.com/">
                            <div class="input-group-append">
                                <button class="input-group-text btn-copy-evaluation-url"
                                    id="new-evaluation-url"
                                    evaluation-url="">
                                    <i class="fa-solid fa-copy"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer justify-content-between">
            <button type="button" class="btn btn-default" data-dismiss="modal">とじる</button>
        </div>
      </div>
    </div>
</div>
<!-- ./modal-request-evaluation -->

<div class="modal" id="modal-create-action">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">{% trans 'create_action' %}</h4>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <form name="add-action-from" id="add-action-form" action="{% url 'add-action' target.uuid %}" method="post">
          {% csrf_token %}
          <div class="modal-body">
            <div class="col form-group">
                <label for="target-item-action-target_item">対象項目</label>
                <select name="target_item" id="target-item-action-target_item" class="form-control">
                    {% for key, task in tasks.items %}
                    {% for item_relation in task.items %}
                    <option value="{{item_relation.id}}">{{task.task.name}} : {{item_relation.item.name}}</option>
                    {% endfor %}
                    {% endfor %}
                </select>
            </div>
            <div class="row">
                <div class="col form-group">
                    <label for="target-item-action-action_type">アクションタイプ</label>
                    {{action_form.action_type}}
                </div>
                <div class="col form-group">
                </div>
            </div>
            <div class="col form-group">
                <label for="target-item-action-name">何をしますか？</label>
                {{action_form.name}}
            </div>
            <div class="col form-group">
                <label for="target-item-action-url">関連URL (講座や書籍のURLを入力してください)</label>
                {{action_form.url}}
            </div>
          </div>

          <div class="modal-footer justify-content-between">
            <button type="button" class="btn btn-default" data-dismiss="modal">とじる</button>
            <button type="submit" class="btn btn-primary btn-task-create">アクションを作成</button>
          </div>
        </form> 
    </div>
</div>
<!-- ./modal-create-action -->


{% endif %}
<!-- REQUIRED SCRIPTS -->

<!-- jQuery -->
<script src="{% static 'admin-lte/plugins/jquery/jquery.min.js' %}"></script>
<!-- Bootstrap 4 -->
<script src="{% static 'admin-lte/plugins/bootstrap/js/bootstrap.bundle.min.js' %}"></script>
<!-- Select2 -->
<script src="{% static 'admin-lte/plugins/select2/js/select2.full.min.js' %}"></script>
<!-- Bootstrap4 Duallistbox -->
<script src="{% static 'admin-lte/plugins/bootstrap4-duallistbox/jquery.bootstrap-duallistbox.min.js' %}"></script>
<!-- InputMask -->
<script src="{% static 'admin-lte/plugins/moment/moment-with-locales.min.js' %}"></script>
<script src="{% static 'admin-lte/plugins/inputmask/min/jquery.inputmask.bundle.min.js' %}"></script>
<!-- Bootstrap Switch -->
<script src="{% static 'admin-lte/plugins/bootstrap-switch/js/bootstrap-switch.min.js' %}"></script>
<!-- AdminLTE App -->
<script src="{% static 'admin-lte/dist/js/adminlte.min.js' %}"></script>
<!-- qrcode.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<!-- common -->
<script src="{% static 'js/common.js' %}"></script>
<script>
var CSRF_TOKEN = '{{csrf_token}}';
{% if authenticated %}
var show_qr_modal = function(url){
    $("#evaluation-url").val(url);
    $("#new-evaluation-url").removeAttr("evaluation-url");
    $("#new-evaluation-url").attr("evaluation-url",url);
    $("#evaluation-url-qrcode").text("");
    new QRCode(document.getElementById("evaluation-url-qrcode"), url);
    $('#modal-request-evaluation').modal('show');
}
$(function(){
    $('.btn-copy-evaluation-url').click(function(e){
        text = $(this).attr("evaluation-url");
        if (navigator.clipboard == undefined) {
            window.clipboardData.setData("Text", text);
        } else {
            navigator.clipboard.writeText(text);
        }
        alert('コピーしました！' + '\n' + text)
    });
    $('.btn-show-request-qr-code').click(function(e){
        url = $(this).attr('evaluation-url');
        show_qr_modal(url);
    });
    $('.btn-request-evaluation').click(function(e){
        url = '{% url "request-evaluation" '000' %}';
        url = url.replace('000','{{target.uuid}}');
        console.log(url);
        data = {}
        data2api(url,'post', data, function(data){
            console.log(data);
            if(data['result'] == 'OK'){
                evaluation_url = '{% url "evaluation" '0000' %}';
                evaluation_url = evaluation_url.replace('0000',data.data.uuid);
                $('#evaluation-url').val('{{ request.scheme }}://{{ request.get_host }}' + evaluation_url);
                $('#new-evaluation-url').removeAttr("evaluation-url");
                $('#new-evaluation-url').attr("evaluation-url",'{{ request.scheme }}://{{ request.get_host }}' + evaluation_url);
                show_qr_modal('{{ request.scheme }}://{{ request.get_host }}' + evaluation_url);
            } else {
            }
        },function(XMLHttpRequest, textStatus, errorThrown){
            alert(errorThrown);
        });
    });
    $('.self-evaluation').change(function(e){
        relationId = $(this).attr('evaluation-id');
        q = '#self-evaluation-val-' + relationId;
        data = {
            self_evaluation : $(this).val(),
            passcode : $('#passcode').val()
        }
        url = '{% url "self-evaluation" '000' %}';
        url = url.replace('000',relationId);
        data2api(url,'post', data, function(data){
            console.log(data);
            if(data['result'] == 'OK'){
            } else {
                str = data['messages'] + "\n";
                for (const [key, value] of Object.entries(data['field_errors'])) {
                    console.log(data['field_errors'][key]);
                    for (const msg of data['field_errors'][key]) {
                        str = str + msg + "\n";
                    }
                }
                alert(str);
                q = '#self-evaluation-'+data.data.id;
                score = $(q).attr('origin-value');
                console.log(q);
                $(q).val($(q).attr('origin-value'));
            }
        },function(XMLHttpRequest, textStatus, errorThrown){
            alert(errorThrown);
        });
    });

    $('.action-progress').change(function(e){
        actionId = $(this).attr('action-id');
        data = {
            progress : $(this).val()
        }
        url = '{% url "action-progress" '000' %}';
        url = url.replace('000',actionId);
        data2api(url,'post', data, function(data){
            console.log(data);
            if(data['result'] == 'OK'){
            } else {
                str = data['messages'] + "\n";
                for (const [key, value] of Object.entries(data['field_errors'])) {
                    console.log(data['field_errors'][key]);
                    for (const msg of data['field_errors'][key]) {
                        str = str + msg + "\n";
                    }
                }
                alert(str);
                q = '#self-evaluation-action-'+data.data.id;
                score = $(q).attr('origin-value');
                $(q).val(score);
            }
        },function(XMLHttpRequest, textStatus, errorThrown){
            alert(errorThrown);
        });
    });
});
{% endif %}
</script>
</body>
</html>
