{% load static %}
{% load i18n %}
{% load mathfilters %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="x-ua-compatible" content="ie=edge">

  <title>{% trans 'site_title' %}</title>

  <!-- Font Awesome Icons -->
  <script src="https://kit.fontawesome.com/86688b6ab0.js" crossorigin="anonymous"></script>
  <!-- Ionicons -->
  <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
  <!-- icheck bootstrap -->
  <link rel="stylesheet" href="{% static 'admin-lte/plugins/icheck-bootstrap/icheck-bootstrap.min.css' %}">
  <!-- Theme style -->
  <link rel="stylesheet" href="{% static 'admin-lte/dist/css/adminlte.min.css' %}">
  <!-- Google Font: Source Sans Pro -->
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700" rel="stylesheet">
  
</head>
<body class="hold-transition fixed layout-top-nav">
<div class="wrapper">

    <div class="content-wrapper">
        <!-- Content Header (Page header) -->
        <div class="content-header">
            <div class="container-fluid">
                <div class="card card-widget widget-user">
                    <!-- Add the bg color to the header using any of the bg-* classes -->
                    <div class="widget-user-header text-white" style="background: url('{% static 'admin-lte/dist/img/photo1.png' %}') center center;">
                        <h1 class="widget-user-title text-white text-left">目標設定シート</h1>
                        <h3 class="widget-user-username text-right">{{target.viewname}}</h3>
                        <h5 class="widget-user-desc text-right">{{target.job}} {{target.last_name}} {{target.first_name}}</h5>
                    </div>
                    <div class="widget-user-image">
                    </div>
                    <div class="card-footer">
                    <div class="row">
                        <div class="col-sm-3 border-right">
                        <div class="description-block">
                            <h5 class="description-header">業界・業種</h5>
                            <span class="description-text">{{target.get_industory_display}}<br>{{target.industory_opt}}</span>
                        </div>
                        <!-- /.description-block -->
                        </div>
                        <!-- /.col -->
                        <div class="col-sm-3 border-right">
                        <div class="description-block">
                            <h5 class="description-header">肩書き</h5>
                            <span class="description-text">{{target.position}}</span>
                        </div>
                        <!-- /.description-block -->
                        </div>
                        <!-- /.col -->
                        <div class="col-sm-3 border-right">
                            <div class="description-block">
                            <h5 class="description-header">概要</h5>
                            <span class="description-text">{{target.description}}</span>
                            </div>
                            <!-- /.description-block -->
                        </div>
                        <!-- /.col -->
                        <div class="col-sm-3">
                        <div class="description-block">
                            <h5 class="description-header">目標作成日</h5>
                            <span class="description-text">{{target.created_at}}</span>
                        </div>
                        <!-- /.description-block -->
                        </div>
                        <!-- /.col -->
                    </div>
                    <!-- /.row -->
                    </div>
                </div>
            </div><!-- /.container-fluid -->
        </div>
        <!-- /.content-header -->

        <!-- Main content -->
        <div class="content">
            <div class="container-fluid">
                {% if messages %}
                <div class="row">
                    {% for message in messages %}
                    <div class="col col-md-12 alert alert-danger" role="alert">
                        {{ message }}
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                <div class="row">
                    <div class="col col-12 text-right">
                        パスコード：<input class="form-group pull-right" type="password" name="passcode" id="passcode" size="10" value="">
                    </div>
                </div>
                {% for key, task in tasks.items %}
                <div class="row">
                    <div class="col-12">
                        <div class="card card-outline card-success">
                            <div class="card-header">
                                <h3 class="card-title">{{task.task.parent.parent.name}} -> {{task.task.parent.name}} -> {{task.task.name}}</h3>
                                <div class="card-tools">
                                    <button class="float-right btn btn-success btn-sm" type="button" data-toggle="collapse"
                                    data-target="#related-skills-{{task.task.id}}" aria-expanded="false"
                                    aria-controls="related-skills-{{task.task.id}}">関連スキル・知識を見る</button>
                                </div>
                                <!-- /.card-tools -->
                            </div>
                            <!-- /.card-header -->
                            <div class="card-body p-2">
                                <div class="row p-2">
                                    <div class="col-md-10 font-weight-bold">
                                        評価項目
                                    </div>
                                    <div class="col-md-2 font-weight-bold text-right">
                                        自己評価
                                    </div>
                                </div>
                                {% for item_relation in task.items %}
                                <div class="row p-3">
                                    <div class="col-md-1 font-weight-bold text-nowrap">
                                        {{item_relation.item.code}}
                                    </div>
                                    <div class="col-md-9">
                                        <div class="row p-0 font-weight-bold">
                                            {{item_relation.item.name}}
                                        </div>
                                        {% for action in item_relation.actions.all %}
                                        <div class="row p-0 pl-3">
                                            {% if action.url %}<a href="{{action.url}}" target="_blank">{% endif %}
                                                {{action.name}}
                                            {% if action.url %}</a>{% endif %}
                                        </div>
                                        {% endfor %}
                                    </div>
                                    <div class="col-md-2 text-right">
                                        <input type="range" class="multi-range self-evaluation" min="0" max="100" step="20"
                                        id="self-evaluation-{{item_relation.id}}"
                                        evaluation-id="{{item_relation.id}}"
                                        name="self-evaluation"
                                        value="{% if item_relation.self_evaluation %}{{item_relation.self_evaluation}}{% else %}0{% endif %}"
                                        origin-value="{% if item_relation.self_evaluation %}{{item_relation.self_evaluation}}{% else %}0{% endif %}">
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            <!-- /.card-footer -->
                            <div class="card-body">
                                {% for profile in task.profiles %}
                                <span class="badge badge-secondary" data-toggle="tooltip" data-placement="top"
                                    title="{{profile.description}}">{{profile.name}}</span>
                                {% endfor %}
                            </div>
                            <div class="card-body collapse" id="related-skills-{{task.task.id}}">
                                {% for skill in task.skills %}
                                <br>
                                <span class="badge badge-success" data-toggle="tooltip" data-placement="top"
                                    title="{{skill.description}}">{{skill.name}}</span>
                                    {% for knowledge in skill.knowledges.all %}
                                    <span class="badge badge-secondary" data-toggle="tooltip" data-placement="top"
                                    title="{{knowledge.description}}">{{knowledge.name}}</span>
                                    {% endfor %}
                                {% endfor %}
                            </div>
                            <!-- /.card-body -->
                        </div>
                    </div>
                </div>
                {% endfor %}
                <hr>
                <div class="row">
                    <div class="col-md-6">
                        <form name="add-action-from" id="add-action-form" action="{% url 'add-action' target.uuid %}" method="post">
                            {% csrf_token %}
                            <div class="card card-outline card-primary">
                                <div class="card-header">
                                    <h3 class="card-title">目標に対するアクションを設定</h3>
                                    <div class="card-tools">
                                    </div>
                                    <!-- /.card-tools -->
                                </div>
                                <!-- /.card-header -->
                                <div class="card-body p-3">
                                    <div class="col form-group">
                                        <label for="target-item-action-target_item">対象項目</label>
                                        <select name="target_item" id="target-item-action-target_item" class="form-control">
                                            {% for key, task in tasks.items %}
                                            {% for item_relation in task.items %}
                                            <option value="{{item_relation.id}}">{{task.task.name}} : {{item_relation.item.name}}</option>
                                            {% endfor %}
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="row">
                                        <div class="col form-group">
                                            <label for="target-item-action-action_type">アクションタイプ</label>
                                            {{action_form.action_type}}
                                        </div>
                                        <div class="col form-group">
                                            <label for="target-item-action-name">パスコード</label>
                                            <input type="password" name="passcode" id="target-item-action-passcode" class="form-control" value="">
                                        </div>
                                    </div>
                                    <div class="col form-group">
                                        <label for="target-item-action-name">何をしますか？</label>
                                        {{action_form.name}}
                                    </div>
                                    <div class="col form-group">
                                        <label for="target-item-action-url">関連URL (講座や書籍のURLを入力してください)</label>
                                        {{action_form.url}}
                                    </div>
                                    <div class="form-group">
                                        <button type="submit" class="btn btn-primary mb-2">登録</button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="col-md-6">
                        <div class="card card-outline card-primary">
                            <div class="card-header">
                                <h3 class="card-title">説明・ご注意</h3>
                                <div class="card-tools">
                                </div>
                                <!-- /.card-tools -->
                            </div>
                            <!-- /.card-header -->
                            <div class="card-body p-3">
                                <ul>
                                    <li>目標設定は3〜5項目で3ヶ月前後を目処に振り返りをしてまた新しく作るというサイクルが良いと思います。本ページをブックマークするなりURLをとっておいて見直し、自己評価を振り返ると良いでしょう。</li>
                                    <li>「関連スキル・知識を見る」ボタンを押すと、単語が展開されます。必要な知識を得るための書籍や講座を検索するのにご利用ください。</li>
                                    <li>目標に対するアクションを設定しておくと、進捗・達成率を記録できるようになります（時間があるときにちょこちょこと実装します）</li>
                                    <li>本ツールは現状あくまで個人で運用しているツールです。ご利用は無料です。何かご意見・ご質問等ありましたが現状はTwitterの方でお願いします。</li>
                                    <li>目標設定URLはランダムでユニークに発行されており、本システムで他人のURLを無断で公開することはありません。目標設定URLの取り扱いはあくまで自己責任でお願いいたします。</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
        <!-- /.Main content -->

    </div>
    <!-- /. content-wrapper -->

    <!-- Main Footer -->
    <footer class="main-footer">
        <!-- To the right -->
        <div class="float-right d-none d-sm-inline">
        </div>
        <!-- Default to the left -->
        <strong>Copyright &copy; 2022- <a href="https://twitter.com/haruchaco" target="_blank"><i class="fa-brands fa-twitter"></i></a>.</strong> All rights reserved.
    </footer>

</div>
<!-- /. wrapper -->

<!-- REQUIRED SCRIPTS -->

<!-- jQuery -->
<script src="{% static 'admin-lte/plugins/jquery/jquery.min.js' %}"></script>
<!-- Bootstrap 4 -->
<script src="{% static 'admin-lte/plugins/bootstrap/js/bootstrap.bundle.min.js' %}"></script>
<!-- Select2 -->
<script src="{% static 'admin-lte/plugins/select2/js/select2.full.min.js' %}"></script>
<!-- Bootstrap4 Duallistbox -->
<script src="{% static 'admin-lte/plugins/bootstrap4-duallistbox/jquery.bootstrap-duallistbox.min.js' %}"></script>
<!-- InputMask -->
<script src="{% static 'admin-lte/plugins/moment/moment-with-locales.min.js' %}"></script>
<script src="{% static 'admin-lte/plugins/inputmask/min/jquery.inputmask.bundle.min.js' %}"></script>
<!-- Bootstrap Switch -->
<script src="{% static 'admin-lte/plugins/bootstrap-switch/js/bootstrap-switch.min.js' %}"></script>
<!-- AdminLTE App -->
<script src="{% static 'admin-lte/dist/js/adminlte.min.js' %}"></script>
<!-- common -->
<script src="{% static 'js/common.js' %}"></script>
<script>
var CSRF_TOKEN = '{{csrf_token}}';
var changeScoreBadge = function(query, score){
    if(score){
        score = score;
    } else {
        score = 0;
    }
    $(query).text(score);
    if(score<=30){
        $(query).removeClass('bg-primary');
        $(query).removeClass('bg-warning');
        $(query).addClass('bg-danger');
    } else if(score<=60){
        $(query).removeClass('bg-primary');
        $(query).removeClass('bg-danger');
        $(query).addClass('bg-warning');
    } else {
        $(query).removeClass('bg-warning');
        $(query).removeClass('bg-danger');
        $(query).addClass('bg-primary');
    }
}
$(function(){
    $('.self-evaluation').change(function(e){
        relationId = $(this).attr('evaluation-id');
        q = '#self-evaluation-val-' + relationId;
        changeScoreBadge(q,$(this).val());
        data = {
            self_evaluation : $(this).val(),
            passcode : $('#passcode').val()
        }
        url = '{% url "self-evaluation" '000' %}';
        url = url.replace('000',relationId);
        data2api(url,'post', data, function(data){
            console.log(data);
            if(data['result'] == 'OK'){
            } else {
                str = data['messages'] + "\n";
                for (const [key, value] of Object.entries(data['field_errors'])) {
                    console.log(data['field_errors'][key]);
                    for (const msg of data['field_errors'][key]) {
                        str = str + msg + "\n";
                    }
                }
                alert(str);
                q = '#self-evaluation-'+data.data.id;
                score = $(q).attr('origin-value');
                console.log(q);
                $(q).val($(q).attr('origin-value'));
                q = '#self-evaluation-val-' + data.data.id;
                changeScoreBadge(q,score);
            }
        },function(XMLHttpRequest, textStatus, errorThrown){
            alert(errorThrown);
        });
    });
});
</script>
</body>
</html>
