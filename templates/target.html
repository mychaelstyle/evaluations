{% load static %}
{% load i18n %}
{% load mathfilters %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="x-ua-compatible" content="ie=edge">

  <title>{% trans 'site_title' %}</title>

  <!-- Font Awesome Icons -->
  <script src="https://kit.fontawesome.com/86688b6ab0.js" crossorigin="anonymous"></script>
  <!-- Ionicons -->
  <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
  <!-- icheck bootstrap -->
  <link rel="stylesheet" href="{% static 'admin-lte/plugins/icheck-bootstrap/icheck-bootstrap.min.css' %}">
  <!-- Theme style -->
  <link rel="stylesheet" href="{% static 'admin-lte/dist/css/adminlte.min.css' %}">
  <!-- Google Font: Source Sans Pro -->
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700" rel="stylesheet">
  
</head>
<body class="hold-transition fixed layout-top-nav">
<div class="wrapper">

    <div class="content-wrapper">
        <!-- Content Header (Page header) -->
        <div class="content-header">
            <div class="container-fluid">
                <div class="card card-widget widget-user">
                    <!-- Add the bg color to the header using any of the bg-* classes -->
                    <div class="widget-user-header text-white" style="background: url('{% static 'admin-lte/dist/img/photo1.png' %}') center center;">
                        <h1 class="widget-user-title text-white text-left">目標設定シート</h1>
                        <h3 class="widget-user-username text-right">{{target.viewname}}</h3>
                        <h5 class="widget-user-desc text-right">{{target.job}} {{target.last_name}} {{target.first_name}}</h5>
                    </div>
                    <div class="widget-user-image">
                    </div>
                    <div class="card-footer">
                    <div class="row">
                        <div class="col-sm-3 border-right">
                        <div class="description-block">
                            <h5 class="description-header">業界・業種</h5>
                            <span class="description-text">{{target.get_industory_display}}<br>{{target.industory_opt}}</span>
                        </div>
                        <!-- /.description-block -->
                        </div>
                        <!-- /.col -->
                        <div class="col-sm-3 border-right">
                        <div class="description-block">
                            <h5 class="description-header">肩書き</h5>
                            <span class="description-text">{{target.position}}</span>
                        </div>
                        <!-- /.description-block -->
                        </div>
                        <!-- /.col -->
                        <div class="col-sm-3 border-right">
                            <div class="description-block">
                            <h5 class="description-header">概要</h5>
                            <span class="description-text">{{target.description}}</span>
                            </div>
                            <!-- /.description-block -->
                        </div>
                        <!-- /.col -->
                        <div class="col-sm-3">
                        <div class="description-block">
                            <h5 class="description-header">目標作成日</h5>
                            <span class="description-text">{{target.created_at}}</span>
                        </div>
                        <!-- /.description-block -->
                        </div>
                        <!-- /.col -->
                    </div>
                    <!-- /.row -->
                    </div>
                </div>
            </div><!-- /.container-fluid -->
        </div>
        <!-- /.content-header -->

        <!-- Main content -->
        <div class="content">
            <div class="container-fluid">
                <div class="row">
                    <div class="col col-12 text-right">
                        パスコード：<input class="form-group pull-right" type="password" name="passcode" id="passcode" size="10" value="">
                    </div>
                </div>
                {% for key, task in tasks.items %}
                <div class="row">
                    <div class="col-12">
                        <div class="card card-outline card-success">
                            <div class="card-header">
                                <h3 class="card-title">{{task.task.parent.parent.name}} -> {{task.task.parent.name}} -> {{task.task.name}}</h3>
                                <div class="card-tools">
                                    <button class="float-right btn btn-success btn-sm" type="button" data-toggle="collapse"
                                    data-target="#related-skills-{{task.task.id}}" aria-expanded="false"
                                    aria-controls="related-skills-{{task.task.id}}">関連スキル・知識を見る</button>
                                </div>
                                <!-- /.card-tools -->
                            </div>
                            <!-- /.card-header -->
                            <div class="card-body p-0">
                                <div class="row p-3">
                                    <div class="col-md-10 font-weight-bold">
                                        評価項目
                                    </div>
                                    <div class="col-md-2 font-weight-bold">
                                        自己評価
                                    </div>
                                </div>
                                {% for item_relation in task.items %}
                                <div class="row p-3">
                                    <div class="col-md-1 font-weight-bold text-nowrap">
                                        {{item_relation.item.code}}
                                    </div>
                                    <div class="col-md-9">
                                        {{item_relation.item.name}}
                                    </div>
                                    <div class="col-md-2 text-right d-flex">
                                        <input type="range" class="multi-range self-evaluation" min="0" max="100" step="20"
                                        id="self-evaluation-{{item_relation.id}}"
                                        evaluation-id="{{item_relation.id}}"
                                        name="self-evaluation"
                                        value="{% if item_relation.self_evaluation %}{{item_relation.self_evaluation}}{% else %}0{% endif %}"
                                        origin-value="{% if item_relation.self_evaluation %}{{item_relation.self_evaluation}}{% else %}0{% endif %}">
                                        <span class="badge bg-{% if item_relation.self_evaluation <= 30 %}danger{% elif item_relation.self_evaluation <= 60 %}warning{% elif item_relation.self_evaluation > 60 %}primary{% else %}danger{% endif %}"
                                            id="self-evaluation-val-{{item_relation.id}}"
                                            >{% if item_relation.self_evaluation %}{{item_relation.self_evaluation}}{% else %}0{% endif %}</span>
                                    </div>
                                </div>
                                <div class="row p-3">
                                    <div class="col-md-12 font-weight-bold text-right">
                                        <a href="#" data-toggle="collapse"
                                        data-target="#related-actions-{{item_relation.id}}" aria-expanded="false"
                                        aria-controls="related-actions-{{item_relation.id}}">アクション設定 <i class="fa-solid fa-plus"></i></a>
                                    </div>
                                </div>
                                <div class="row p-3 collapse form-row align-items-right" id="related-actions-{{item_relation.id}}">
                                    <div class="col-auto">
                                    <label class="sr-only" for="inlineFormInput">アクションタイプ</label>
                                    {{action_form.action_type}}
                                    </div>
                                    <div class="col-auto">
                                        <label class="sr-only" for="inlineFormInputGroup">アクション名</label>
                                        {{action_form.name}}
                                    </div>
                                    <div class="col-auto">
                                        <label class="sr-only" for="inlineFormInputGroup">関連URL</label>
                                        {{action_form.url}}
                                    </div>
                                    <div class="col-auto">
                                        <button type="button" class="btn btn-primary mb-2">登録</button>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            <!-- /.card-footer -->
                            <div class="card-body">
                                {% for profile in task.profiles %}
                                <span class="badge badge-secondary" data-toggle="tooltip" data-placement="top"
                                    title="{{profile.description}}">{{profile.name}}</span>
                                {% endfor %}
                            </div>
                            <div class="card-body collapse" id="related-skills-{{task.task.id}}">
                                {% for skill in task.skills %}
                                <br>
                                <span class="badge badge-success" data-toggle="tooltip" data-placement="top"
                                    title="{{skill.description}}">{{skill.name}}</span>
                                    {% for knowledge in skill.knowledges.all %}
                                    <span class="badge badge-secondary" data-toggle="tooltip" data-placement="top"
                                    title="{{knowledge.description}}">{{knowledge.name}}</span>
                                    {% endfor %}
                                {% endfor %}
                            </div>
                            <!-- /.card-body -->
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        <!-- /.Main content -->

    </div>
    <!-- /. content-wrapper -->

    <!-- Main Footer -->
    <footer class="main-footer">
        <!-- To the right -->
        <div class="float-right d-none d-sm-inline">
        </div>
        <!-- Default to the left -->
        <strong>Copyright &copy; 2014-2019 <a href="https://adminlte.io">AdminLTE.io</a>.</strong> All rights reserved.
    </footer>

</div>
<!-- /. wrapper -->

<!-- REQUIRED SCRIPTS -->

<!-- jQuery -->
<script src="{% static 'admin-lte/plugins/jquery/jquery.min.js' %}"></script>
<!-- Bootstrap 4 -->
<script src="{% static 'admin-lte/plugins/bootstrap/js/bootstrap.bundle.min.js' %}"></script>
<!-- Select2 -->
<script src="{% static 'admin-lte/plugins/select2/js/select2.full.min.js' %}"></script>
<!-- Bootstrap4 Duallistbox -->
<script src="{% static 'admin-lte/plugins/bootstrap4-duallistbox/jquery.bootstrap-duallistbox.min.js' %}"></script>
<!-- InputMask -->
<script src="{% static 'admin-lte/plugins/moment/moment-with-locales.min.js' %}"></script>
<script src="{% static 'admin-lte/plugins/inputmask/min/jquery.inputmask.bundle.min.js' %}"></script>
<!-- Bootstrap Switch -->
<script src="{% static 'admin-lte/plugins/bootstrap-switch/js/bootstrap-switch.min.js' %}"></script>
<!-- AdminLTE App -->
<script src="{% static 'admin-lte/dist/js/adminlte.min.js' %}"></script>
<script>
var CSRF_TOKEN = '{{csrf_token}}';
var data2api = function(url,method,data,donefunc,failfunc){
    $('.overlay').show();
    $.ajax({
        url : url,
        type : method,
        dataType : 'json',
        contentType: 'application/json',
        data: JSON.stringify(data),
        beforeSend: function(xhr, settings) {
                        xhr.setRequestHeader("X-CSRFToken", CSRF_TOKEN);
                    }
    }).done(function(data){
        CSRF_TOKEN = data.csrf_token;
        donefunc(data);
        $('.overlay').hide();
    }).fail(function(XMLHttpRequest, textStatus, errorThrown) {
        failfunc(XMLHttpRequest, textStatus, errorThrown);
        $('.overlay').hide();
    });
}
var changeScoreBadge = function(query, score){
    if(score){
        score = score;
    } else {
        score = 0;
    }
    $(query).text(score);
    if(score<=30){
        $(query).removeClass('bg-primary');
        $(query).removeClass('bg-warning');
        $(query).addClass('bg-danger');
    } else if(score<=60){
        $(query).removeClass('bg-primary');
        $(query).removeClass('bg-danger');
        $(query).addClass('bg-warning');
    } else {
        $(query).removeClass('bg-warning');
        $(query).removeClass('bg-danger');
        $(query).addClass('bg-primary');
    }
}
$(function(){
    $('.self-evaluation').change(function(e){
        relationId = $(this).attr('evaluation-id');
        q = '#self-evaluation-val-' + relationId;
        changeScoreBadge(q,$(this).val());
        data = {
            self_evaluation : $(this).val()
        }
        url = '{% url "self-evaluation" '000' %}';
        url = url.replace('000',relationId);
        data2api(url,'post', data, function(data){
            console.log(data);
            if(data['result'] == 'OK'){
            } else {
                str = data['messages'] + "\n";
                for (const [key, value] of Object.entries(data['field_errors'])) {
                    console.log(data['field_errors'][key]);
                    for (const msg of data['field_errors'][key]) {
                        str = str + msg + "\n";
                    }
                }
                alert(str);
                q = '#self-evaluation-'+data.data.id;
                score = $(q).attr('origin-value');
                console.log(q);
                $(q).val($(q).attr('origin-value'));
                q = '#self-evaluation-val-' + data.data.id;
                changeScoreBadge(q,score);
            }
        },function(XMLHttpRequest, textStatus, errorThrown){
            alert(errorThrown);
        });
    });
});
</script>
</body>
</html>
