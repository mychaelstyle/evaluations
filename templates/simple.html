{% load static %}
{% load i18n %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="x-ua-compatible" content="ie=edge">

  <title>{% trans 'site_title' %}</title>

  <!-- Font Awesome Icons -->
  <script src="https://kit.fontawesome.com/86688b6ab0.js" crossorigin="anonymous"></script>
  <!-- Ionicons -->
  <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
  <!-- icheck bootstrap -->
  <link rel="stylesheet" href="{% static 'admin-lte/plugins/icheck-bootstrap/icheck-bootstrap.min.css' %}">
  <!-- Theme style -->
  <link rel="stylesheet" href="{% static 'admin-lte/dist/css/adminlte.min.css' %}">
  <!-- Google Font: Source Sans Pro -->
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700" rel="stylesheet">
  
</head>
<body class="hold-transition fixed layout-top-nav">
<div class="wrapper">

  <!-- Navbar -->
  <nav class="main-header navbar navbar-expand-md navbar-light navbar-white sticky-top">
    <div class="container">
      <a href="/" class="navbar-brand">
        <span class="brand-text font-weight-light">{% trans 'site_title' %}</span>
      </a>

      <!-- Right navbar links -->
      <ul class="order-1 order-md-3 navbar-nav navbar-no-expand ml-auto">
        <li class="nav-item">
          <a href="#" class="nav-link">Contact</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" data-widget="control-sidebar" href="#" id="open-csidebar">
            <i class="fas fa-th-large"></i>
            <span class="badge badge-danger navbar-badge added-number"></span>
          </a>
        </li>
      </ul>
    </div>
  </nav>
  <!-- /.navbar -->

  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper">
    {% block content %}
    {% endblock %}
  </div>
  <!-- /.content-wrapper -->

  <!-- Main Footer -->
  <footer class="main-footer">
    <!-- To the right -->
    <div class="float-right d-none d-sm-inline">
      Anything you want
    </div>
    <!-- Default to the left -->
    <strong>Copyright &copy; 2014-2019 <a href="https://adminlte.io">AdminLTE.io</a>.</strong> All rights reserved.
  </footer>

  <aside class="control-sidebar control-sidebar-light sticky-top" id="cust_sidebar" style="width:500px;">
    <div class="p-3">
      <h5>目標設定シートの作成</h5>
      <form name="target-create-form" id="target-create-form" action="{% url 'api-target-create' %}" method="post">
        {% csrf_token %}
        <div class="row form-group">
          <input type="text" name="viewname" id="target-viewname" class="form-control" placeholder="目標のタイトル（必須）">
          <div class="invalid-feedback" id="feedback-viewname"></div>
        </div>
        <div class="row form-group">
          <input type="text" name="description" id="target-description" class="form-control" placeholder="目標ので目指す姿（任意）">
          <div class="invalid-feedback" id="feedback-description"></div>
        </div>
        <hr>
        <div id="target-items">
        </div>
        <div class="invalid-feedback" id="feedback-items"></div>
        <hr>
        <div class="row form-group">
          <div class="col">
            <label for="industory">姓</label>
            <input name="last_name" id="target-last_name" type="text" class="form-control" placeholder="姓（任意）">
            <div class="invalid-feedback" id="feedback-last_name"></div>
          </div>
          <div class="col">
            <label for="industory">名</label>
            <input name="first_name" id="target-first_name" type="text" class="form-control" placeholder="名（任意）">
            <div class="invalid-feedback" id="feedback-first_name"></div>
          </div>
        </div>
        <div class="row form-group">
          <div class="col">
            <label for="industory">業界・業種</label>
            {{request.target_create_form.industory}}
          </div>
          <div class="col">
            <label for="target-industory_opt">業界・業種（その他の場合）</label>
            <input name="industory_opt" id="target-industory_opt" type="text" class="form-control" placeholder="分類にない業界を入力">
            <div class="invalid-feedback" id="feedback-industory_opt"></div>
          </div>
        </div>
        <div class="row form-group">
          <div class="col">
            <label for="job">職種</label>
            <input name="job" id="target-job" type="text" class="form-control" placeholder="例）スーパーバイザー">
            <div class="invalid-feedback" id="feedback-position"></div>
          </div>
          <div class="col">
            <label for="grade">グレード</label>
            {{request.target_create_form.grade}}
            <div class="invalid-feedback" id="feedback-grade"></div>
          </div>
        </div>
        <div class="row form-group">
          <div class="col">
            <label for="target-position">肩書き(任意)</label>
            <input name="position" id="target-position" type="text" class="form-control" placeholder="例）係長・チームリーダー">
            <div class="invalid-feedback" id="feedback-position"></div>
          </div>
          <div class="col">
            <label for="target-role">役割(任意)</label>
            <input name="role" id="target-role" type="text" class="form-control" placeholder="例）ユーザーのサポート窓口">
            <div class="invalid-feedback" id="feedback-role"></div>
          </div>
        </div>
        <div class="row form-group">
          <div class="col">
            <label for="target-org_name">会社名(任意)</label>
            <input name="org_name" id="target-org_name" type="text" class="form-control" placeholder="会社名">
            <div class="invalid-feedback" id="feedback-org_name"></div>
          </div>
          <div class="col">
            <label for="target-department_name">部門・部署名(任意)</label>
            <input name="department_name" id="target-department_name" type="text" class="form-control" placeholder="例）○○事業部 開発チーム">
            <div class="invalid-feedback" id="feedback-department_name"></div>
          </div>
        </div>
        <div class="row small p-3">
          ※ 会員登録などはされません。<br>
          ※ 目標設定シートを作成するとUUIDでユニークな目標設定シートURLが発行され、いつでもweb上で見直すことができます。<br>
          ※ UUID付きのURLは意図せず拡散されないように自己責任・自己管理するようお願いします。<br>
        </div>
        <div id="target-create-messages" class="alert alert-danger" style="display:none;"></div>
        <div class="row form-group">
          <button type="button" class="btn btn-primary btn-lg btn-block" id="target-create-button"><span class="small">目標設定シートを作成する</span></button>
        </div>
      </form>
    </div>
  </aside>

  <div class="col-4" id="template-card" style="displpay:noe;">
    <div class="card card-primary card-outline">
        <div class="card-header">
            <h5 class="card-title m-0"></h5>
            <div class="card-tools">
              <div class="task-tree small"></div>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="card-text"></div>
            <table class="table table-striped table-valign-middle table_sticky">
                <tbody class="task-items overflow-auto" style="display:block; height: 250px;">
                </tbody>
            </table>
        </div>
        <div class="card-footer">
        </div>
    </div>
  </div>

</div>
<!-- ./wrapper -->

<!-- REQUIRED SCRIPTS -->

<!-- jQuery -->
<script src="{% static 'admin-lte/plugins/jquery/jquery.min.js' %}"></script>
<!-- Bootstrap 4 -->
<script src="{% static 'admin-lte/plugins/bootstrap/js/bootstrap.bundle.min.js' %}"></script>
<!-- Select2 -->
<script src="{% static 'admin-lte/plugins/select2/js/select2.full.min.js' %}"></script>
<!-- Bootstrap4 Duallistbox -->
<script src="{% static 'admin-lte/plugins/bootstrap4-duallistbox/jquery.bootstrap-duallistbox.min.js' %}"></script>
<!-- InputMask -->
<script src="{% static 'admin-lte/plugins/moment/moment-with-locales.min.js' %}"></script>
<script src="{% static 'admin-lte/plugins/inputmask/min/jquery.inputmask.bundle.min.js' %}"></script>
<!-- Bootstrap Switch -->
<script src="{% static 'admin-lte/plugins/bootstrap-switch/js/bootstrap-switch.min.js' %}"></script>
<!-- AdminLTE App -->
<script src="{% static 'admin-lte/dist/js/adminlte.min.js' %}"></script>
<script>
var CSRF_TOKEN = $("input[name='csrfmiddlewaretoken']").val();

var form2json = function(formid) {
  var data = $(formid).serializeArray();
  var returnJson = {};
  for (idx = 0; idx < data.length; idx++) {
    returnJson[data[idx].name] = data[idx].value
  }
  return returnJson;
}

var form2api = function(url,method,formid,donefunc,failfunc) {
  data = form2json(formid);
  data2api(url,method,data,donefunc,failfunc);
}

var data2api = function(url,method,data,donefunc,failfunc){
  $('.overlay').show();
  $.ajax({
    url : url,
    type : method,
    dataType : 'json',
    contentType: 'application/json',
    data: JSON.stringify(data),
    beforeSend: function(xhr, settings) {
                    xhr.setRequestHeader("X-CSRFToken", CSRF_TOKEN);
                }
  }).done(function(data){
    CSRF_TOKEN = data.csrf_token;
    donefunc(data);
    $('.overlay').hide();
  }).fail(function(XMLHttpRequest, textStatus, errorThrown) {
    failfunc(XMLHttpRequest, textStatus, errorThrown);
    $('.overlay').hide();
  });
}
var postfile2api = function(url,formid,donefunc,failfunc){
  $('.overlay').show();
  data = new FormData($(formid).get(0));
  token = $("input[name='csrfmiddlewaretoken']").val();
  $.ajax({
    url : url,
    type : "POST",
    processData: false,
    contentType: false,
    data: data,
    beforeSend: function(xhr, settings) {
                    xhr.setRequestHeader("X-CSRFToken", token);
                }
  }).done(function(data){
    donefunc(data);
    $('.overlay').hide();
  }).fail(function(XMLHttpRequest, textStatus, errorThrown) {
    failfunc(XMLHttpRequest, textStatus, errorThrown);
    $('.overlay').hide();
  });
}
$(function(){
  $('#target-create-button').on('click',function(e){
    data = form2json('#target-create-form');
    document.cookie = 'first_name=' + encodeURIComponent(data['first_name']);
    document.cookie = 'last_name=' + encodeURIComponent(data['last_name']);
    document.cookie = 'org_name=' + encodeURIComponent(data['org_name']);
    document.cookie = 'department_name=' + encodeURIComponent(data['department_name']);
    document.cookie = 'industory=' + encodeURIComponent(data['industory']);
    document.cookie = 'industory_opt=' + encodeURIComponent(data['industory_opt']);
    document.cookie = 'position=' + encodeURIComponent(data['position']);
    document.cookie = 'job=' + encodeURIComponent(data['job']);
    document.cookie = 'role=' + encodeURIComponent(data['role']);
    document.cookie = 'grade=' + encodeURIComponent(data['grade']);
    url = '{% url 'api-target-create' %}';
    item_ids = [];
    for (const [key, value] of Object.entries(SELECTED)) {
      item_ids.push(value.id);
    }
    data.items = item_ids;
    console.log(data);
    data2api(url,'POST',data,function(data){
      if(data['result']=='NG'){
        for (const [key, value] of Object.entries(data['messages'])) {
          $('#target-create-messages').text($('#target-create-messages').text() + value);
          $('#target-create-messages').show();
        }
        for (const [key, value] of Object.entries(data['field_errors'])) {
          divname = '#feedback-' + key;
          inputname = '#target-' + key;
          $(inputname).addClass('is-invalid');
          for (idx = 0; idx < value.length; idx++) {
            $(divname).text($(divname).text()+value[idx]);
          }
        }
      } else {
        console.log(data);
        url = '/target/' + data['data']['uuid'];
        window.location.href = url;
      }
    },function(XMLHttpRequest, textStatus, errorThrown){
      alert(errorThrown);
    });
  });
  const cookies = document.cookie;
  const array = cookies.split(';');
  array.forEach(function(value) {
    const content = value.split('=');
    key = '#target-' + content[0].trim();
    $(key).val(decodeURIComponent(content[1]));
  })
})
</script>
{% block scripts %}
{% endblock %}
</body>
</html>